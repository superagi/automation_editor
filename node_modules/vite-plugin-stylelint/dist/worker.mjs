import { workerData, parentPort } from 'node:worker_threads';
import debugWrap from 'debug';
import { P as PLUGIN_NAME, a as getFilter, i as initializeStylelint, l as lintFiles, s as shouldIgnoreModule, b as getFilePath } from './shared/vite-plugin-stylelint.BQrEPIRa.mjs';
import '@rollup/pluginutils';

const debug = debugWrap(`${PLUGIN_NAME}:worker`);
const options = workerData.options;
const filter = getFilter(options);
let stylelintInstance;
let formatter;
const initPromise = initializeStylelint(options).then((result) => {
  stylelintInstance = result.stylelintInstance;
  formatter = result.formatter;
  return result;
});
(async () => {
  debug("==== worker start ====");
  debug("Initialize Stylelint");
  const { stylelintInstance: stylelintInstance2, formatter: formatter2 } = await initPromise;
  if (options.lintOnStart) {
    debug("Lint on start");
    lintFiles({
      files: options.include,
      stylelintInstance: stylelintInstance2,
      formatter: formatter2,
      options
    });
  }
})();
parentPort?.on("message", async (id) => {
  if (!stylelintInstance) await initPromise;
  debug("==== message event ====");
  debug(`id: ${id}`);
  const shouldIgnore = shouldIgnoreModule(id, filter);
  debug(`should ignore: ${shouldIgnore}`);
  if (shouldIgnore) return;
  const filePath = getFilePath(id);
  debug(`filePath: ${filePath}`);
  lintFiles({
    files: options.lintDirtyOnly ? filePath : options.include,
    stylelintInstance,
    formatter,
    options
  });
});
